import requests
from bs4 import BeautifulSoup
import pandas as pd
import os

# ===============================================
# FUNCIONES DE SCRAPING - TRANSFERMARKT
# ===============================================

def obtener_tabla_posiciones():
    """Scrapea la tabla de posiciones de LaLiga 2024/25 desde Transfermarkt"""
    url = "https://www.transfermarkt.com/laliga/tabelle/wettbewerb/ES1/saison_id/2024"
    headers = {
        "User-Agent": (
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64) "
            "AppleWebKit/537.36 (KHTML, like Gecko) "
            "Chrome/130.0.0.0 Safari/537.36"
        ),
        "Accept-Language": "es-ES,es;q=0.9,en;q=0.8"
    }

    res = requests.get(url, headers=headers)
    if res.status_code != 200:
        print(f"Error al conectar ({res.status_code}).")
        return pd.DataFrame()

    soup = BeautifulSoup(res.text, "html.parser")
    tabla = soup.find("table", {"class": "items"})
    if not tabla:
        print("No se encontró la tabla de posiciones.")
        return pd.DataFrame()

    filas = tabla.find("tbody").find_all("tr", recursive=False)
    posiciones, equipos, pj, g, e, p, gf, gc, dg, pts = [], [], [], [], [], [], [], [], [], []

    for fila in filas:
        columnas = fila.find_all("td", recursive=False)
        if len(columnas) >= 10:
            posiciones.append(columnas[0].get_text(strip=True))
            equipo_tag = columnas[1].find("a")
            equipos.append(equipo_tag.get_text(strip=True) if equipo_tag else columnas[1].get_text(strip=True))
            pj.append(columnas[2].get_text(strip=True))
            g.append(columnas[3].get_text(strip=True))
            e.append(columnas[4].get_text(strip=True))
            p.append(columnas[5].get_text(strip=True))
            gf.append(columnas[6].get_text(strip=True))
            gc.append(columnas[7].get_text(strip=True))
            dg.append(columnas[8].get_text(strip=True))
            pts.append(columnas[9].get_text(strip=True))

    df = pd.DataFrame({
        "Pos": posiciones,
        "Equipo": equipos,
        "PJ": pj,
        "G": g,
        "E": e,
        "P": p,
        "GF": gf,
        "GC": gc,
        "DG": dg,
        "Pts": pts
    })
    print("✅ Tabla de posiciones obtenida correctamente.")
    return df


def obtener_goleadores():
    """Scrapea los goleadores de LaLiga 2024/25 desde Transfermarkt"""
    url = "https://www.transfermarkt.com/laliga/torschuetzenliste/wettbewerb/ES1/saison_id/2024"
    headers = {
        "User-Agent": (
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64) "
            "AppleWebKit/537.36 (KHTML, like Gecko) "
            "Chrome/130.0.0.0 Safari/537.36"
        ),
        "Accept-Language": "es-ES,es;q=0.9,en;q=0.8"
    }

    res = requests.get(url, headers=headers)
    if res.status_code != 200:
        print(f"Error al conectar ({res.status_code}).")
        return pd.DataFrame()

    soup = BeautifulSoup(res.text, "html.parser")
    tabla = soup.find("table", {"class": "items"})
    if not tabla:
        print("No se encontró la tabla de goleadores.")
        return pd.DataFrame()

    filas = tabla.find("tbody").find_all("tr", recursive=False)
    posiciones, jugadores, equipos, goles = [], [], [], []

    for fila in filas:
        columnas = fila.find_all("td", recursive=False)
        if len(columnas) < 5:
            continue

        # Posición
        posiciones.append(columnas[0].get_text(strip=True))

        # Buscar nombre del jugador (primer enlace en la fila con href hacia /spieler/)
        jugador_tag = fila.find("a", href=lambda x: x and "/spieler/" in x)
        jugador = jugador_tag.get_text(strip=True) if jugador_tag else "Desconocido"
        jugadores.append(jugador)

        # Buscar equipo (primer enlace en la fila con href hacia /verein/)
        equipo_tag = fila.find("a", href=lambda x: x and "/verein/" in x)
        equipo = equipo_tag.get_text(strip=True) if equipo_tag else "Sin equipo"
        equipos.append(equipo)

        # Buscar columna de goles (última celda con número)
        goles_encontrado = None
        for td in reversed(columnas):
            texto = td.get_text(strip=True)
            if texto.isdigit():
                goles_encontrado = texto
                break
        goles.append(goles_encontrado if goles_encontrado else "0")

    df = pd.DataFrame({
        "Pos": posiciones,
        "Jugador": jugadores,
        "Equipo": equipos,
        "Goles": goles
    })

    print("✅ Tabla de goleadores obtenida correctamente.")
    return df


# ===============================================
# UTILIDADES
# ===============================================

def mostrar_tabla(df, titulo):
    print("\n" + "=" * 80)
    print(titulo.center(80))
    print("=" * 80)
    if df.empty:
        print("No hay datos para mostrar.\n")
    else:
        print(df.head(10).to_string(index=False))
        print("\n(Se muestran los primeros 10 registros)\n")


def guardar_csv(df, nombre_archivo):
    if df.empty:
        print(f"No se pudo guardar {nombre_archivo} porque está vacío.")
        return
    ruta = os.path.join(os.getcwd(), nombre_archivo)
    df.to_csv(ruta, index=False, encoding="utf-8-sig")
    print(f"Archivo guardado como: {ruta}")


# ===============================================
# MENÚ PRINCIPAL
# ===============================================

def main():
    while True:
        print("=== MENÚ LIGA ESPAÑOLA (TEMPORADA 2024/25) ===")
        print("1. Ver tabla de posiciones")
        print("2. Ver tabla de goleadores")
        print("3. Ver tabla de asistidores (no disponible)")
        print("4. Descargar tablas (sin asistidores)")
        print("5. Salir")

        opcion = input("\nElige una opción: ")

        if opcion == "1":
            df = obtener_tabla_posiciones()
            mostrar_tabla(df, "TABLA DE POSICIONES")

        elif opcion == "2":
            df = obtener_goleadores()
            mostrar_tabla(df, "TABLA DE GOLEADORES")

        elif opcion == "3":
            print("\n❌ Tabla de asistidores no disponible actualmente.\n")

        elif opcion == "4":
            print("\nDescargando tablas...")
            guardar_csv(obtener_tabla_posiciones(), "tabla_posiciones.csv")
            guardar_csv(obtener_goleadores(), "tabla_goleadores.csv")
            print("✅ Tablas descargadas correctamente.\n")

        elif opcion == "5":
            print("\nSaliendo del programa...")
            break

        else:
            print("\nOpción no válida, intenta de nuevo.\n")


if __name__ == "__main__":
    main()
